<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Trajectory Viewer - CooperBench</title>
        <meta
            name="description"
            content="View and analyze multi-agent execution trajectories from CooperBench experiments"
        />
        <link rel="icon" type="image/svg+xml" href="static/images/favicon.svg?v=2" />

        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        />

        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ["Nebula Sans", "system-ui", "sans-serif"],
                        },
                    },
                },
            };
        </script>

        <style>
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Light.woff2") format("woff2");
                font-weight: 300;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-LightItalic.woff2")
                    format("woff2");
                font-weight: 300;
                font-style: italic;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Book.woff2") format("woff2");
                font-weight: 400;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-BookItalic.woff2")
                    format("woff2");
                font-weight: 400;
                font-style: italic;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Medium.woff2") format("woff2");
                font-weight: 500;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-MediumItalic.woff2")
                    format("woff2");
                font-weight: 500;
                font-style: italic;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Semibold.woff2")
                    format("woff2");
                font-weight: 600;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-SemiboldItalic.woff2")
                    format("woff2");
                font-weight: 600;
                font-style: italic;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Bold.woff2") format("woff2");
                font-weight: 700;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-BoldItalic.woff2")
                    format("woff2");
                font-weight: 700;
                font-style: italic;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-Black.woff2") format("woff2");
                font-weight: 800;
                font-style: normal;
                font-display: swap;
            }
            @font-face {
                font-family: "Nebula Sans";
                src: url("static/fonts/NebulaSans-BlackItalic.woff2")
                    format("woff2");
                font-weight: 800;
                font-style: italic;
                font-display: swap;
            }
            .step-card {
                transition: all 0.15s ease;
                overflow-wrap: break-word;
                word-break: break-word;
            }
            .step-card:hover {
                transform: translateX(2px);
            }
            /* Ensure code/paths don't overflow on mobile */
            .step-card code,
            .step-card .font-mono {
                word-break: break-all;
            }
            .timeline-block {
                transition: opacity 0.15s ease;
            }
            .timeline-block:hover {
                opacity: 0.8;
            }
            pre {
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .highlight-ring {
                animation: pulse-ring 1.5s ease-out;
            }
            @keyframes pulse-ring {
                0% {
                    box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(250, 204, 21, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(250, 204, 21, 0);
                }
            }
            .line-clamp-2 {
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
            body,
            .font-sans,
            h1, h2, h3, h4, h5, h6 {
                font-family: "Nebula Sans", system-ui, sans-serif !important;
            }
        </style>
    </head>

    <body class="bg-gray-50 text-gray-900 font-sans overflow-x-hidden">
        <!-- Header -->
        <header
            class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur border-b border-gray-200 z-50"
        >
            <div class="max-w-6xl mx-auto px-4 md:px-6">
                <div class="flex items-center justify-between h-14">
                    <a href="index.html" class="flex items-center gap-2 text-base md:text-lg font-semibold text-gray-900">
                        <img src="static/images/favicon.svg" alt="" class="w-6 h-6">
                        CooperBench
                    </a>
                    <!-- Desktop Navigation -->
                    <nav class="hidden md:flex items-center gap-6">
                        <a href="leaderboard.html" class="text-sm text-gray-600 hover:text-gray-900">Leaderboard</a>
                        <a href="tasks.html" class="text-sm text-gray-600 hover:text-gray-900">Tasks</a>
                        <a href="viewer.html" class="text-sm text-gray-900 font-medium">Trajectories</a>
                        <a href="blog.html" class="text-sm text-gray-600 hover:text-gray-900">Blog</a>
                        <a href="static/pdfs/main.pdf" target="_blank" class="text-sm text-gray-600 hover:text-gray-900">Paper <span class="text-xs">↗</span></a>
                        <a href="https://github.com/cooperbench/CooperBench" target="_blank" class="text-gray-600 hover:text-gray-900"><i class="fab fa-github"></i></a>
                    </nav>

                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-btn" class="md:hidden p-2 text-gray-600 hover:text-gray-900" onclick="toggleMobileMenu()">
                        <i id="menu-icon" class="fas fa-bars text-lg"></i>
                    </button>
                </div>

                <!-- Mobile Navigation -->
                <nav id="mobile-menu" class="hidden md:hidden border-t border-gray-100 py-3">
                    <div class="flex flex-col gap-3">
                        <a href="leaderboard.html" class="text-sm text-gray-600 hover:text-gray-900 py-1">Leaderboard</a>
                        <a href="tasks.html" class="text-sm text-gray-600 hover:text-gray-900 py-1">Tasks</a>
                        <a href="viewer.html" class="text-sm text-gray-900 font-medium py-1">Trajectories</a>
                        <a href="blog.html" class="text-sm text-gray-600 hover:text-gray-900 py-1">Blog</a>
                        <a href="https://arxiv.org/abs/2601.13295" target="_blank" class="text-sm text-gray-600 hover:text-gray-900 py-1">Paper <span class="text-xs">↗</span></a>
                        <a href="https://github.com/cooperbench/CooperBench" target="_blank" class="text-sm text-gray-600 hover:text-gray-900 py-1"><i class="fab fa-github mr-2"></i>GitHub</a>
                    </div>
                </nav>
            </div>
        </header>

        <main class="pt-14">
            <!-- Page Header -->
            <div class="bg-white border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-8">
                    <h1 class="text-xl md:text-2xl font-semibold text-gray-900 mb-2">Trajectory Viewer</h1>
                    <p class="text-sm md:text-base text-gray-600">Explore multi-agent collaboration failures and coordination breakdowns</p>
                </div>
            </div>

            <!-- Filters Bar -->
            <div class="bg-white border-b border-gray-200 sticky top-14 z-40">
                <div class="max-w-7xl mx-auto px-4 md:px-6 py-3 md:py-4">
                    <div class="flex items-center gap-2 md:gap-4 overflow-x-auto">
                        <span class="hidden md:inline text-sm text-gray-500 flex-shrink-0">Failure cause:</span>
                        <div class="flex gap-2 flex-shrink-0">
                            <button
                                onclick="loadRandomExample('expectation')"
                                class="px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors whitespace-nowrap"
                            >
                                Expectation
                                <span id="count-expectation" class="text-xs text-gray-400">(0)</span>
                            </button>
                            <button
                                onclick="loadRandomExample('communication')"
                                class="px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors whitespace-nowrap"
                            >
                                Communication
                                <span id="count-communication" class="text-xs text-gray-400">(0)</span>
                            </button>
                            <button
                                onclick="loadRandomExample('commitment')"
                                class="px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300 transition-colors whitespace-nowrap"
                            >
                                Commitment
                                <span id="count-commitment" class="text-xs text-gray-400">(0)</span>
                            </button>
                        </div>
                        <button
                            onclick="clearViewer()"
                            class="ml-auto text-xs md:text-sm text-gray-400 hover:text-gray-600 flex-shrink-0"
                        >
                            Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="max-w-7xl mx-auto px-4 md:px-6 py-4 md:py-6">
            <!-- Hidden file inputs -->
            <input
                type="file"
                id="file-agent-a"
                accept=".json"
                class="hidden"
            />
            <input
                type="file"
                id="file-agent-b"
                accept=".json"
                class="hidden"
            />
            <textarea id="json-input" class="hidden"></textarea>

            <!-- Status -->
            <div id="load-status" class="mb-3 text-xs hidden"></div>

            <!-- Viewer Section -->
            <section id="viewer-section" class="hidden">
                <!-- Stats & Legend -->
                <div
                    class="flex flex-wrap items-center gap-4 text-[11px] text-gray-500 mb-3"
                >
                    <span class="text-red-600 font-medium"
                        >A: <span id="stats-agent-a">0</span></span
                    >
                    <span class="text-blue-600 font-medium"
                        >B: <span id="stats-agent-b">0</span></span
                    >
                    <span id="stats-duration">0s</span>
                    <span class="text-gray-300">|</span>
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-yellow-400 rounded-sm"></span
                        >Bash</span
                    >
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-sky-300 rounded-sm"></span
                        >Find</span
                    >
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-blue-600 rounded-sm"></span
                        >View</span
                    >
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-green-500 rounded-sm"></span
                        >Edit</span
                    >
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-orange-400 rounded-sm"></span
                        >Comm</span
                    >
                    <span class="flex items-center gap-1"
                        ><span class="w-2 h-2 bg-red-500 rounded-sm"></span
                        >Submit</span
                    >
                </div>

                <!-- Timeline -->
                <div
                    class="bg-white rounded-lg border border-gray-200 p-3 mb-4"
                >
                    <div class="space-y-1.5">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-red-500 w-4">A</span>
                            <div
                                id="timeline-a"
                                class="relative h-3 bg-gray-100 rounded flex-1 overflow-hidden"
                            ></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] text-blue-500 w-4">B</span>
                            <div
                                id="timeline-b"
                                class="relative h-3 bg-gray-100 rounded flex-1 overflow-hidden"
                            ></div>
                        </div>
                    </div>
                    <div
                        id="time-markers"
                        class="flex justify-between mt-1.5 pl-6 text-[9px] text-gray-400"
                    ></div>
                </div>

                <!-- Filter Controls -->
                <div class="flex flex-wrap items-center gap-3 mb-4 text-[11px]">
                    <span class="text-gray-400">Filter:</span>
                    <label
                        class="flex items-center gap-1 cursor-pointer text-gray-600"
                    >
                        <input
                            type="checkbox"
                            id="filter-comm"
                            checked
                            class="w-3 h-3 rounded"
                            onchange="applyFilters()"
                        />
                        <span>Comm</span>
                    </label>
                    <label
                        class="flex items-center gap-1 cursor-pointer text-gray-600"
                    >
                        <input
                            type="checkbox"
                            id="filter-edit"
                            checked
                            class="w-3 h-3 rounded"
                            onchange="applyFilters()"
                        />
                        <span>Edit</span>
                    </label>
                    <label
                        class="flex items-center gap-1 cursor-pointer text-gray-600"
                    >
                        <input
                            type="checkbox"
                            id="filter-view"
                            checked
                            class="w-3 h-3 rounded"
                            onchange="applyFilters()"
                        />
                        <span>View</span>
                    </label>
                    <label
                        class="flex items-center gap-1 cursor-pointer text-gray-600"
                    >
                        <input
                            type="checkbox"
                            id="filter-bash"
                            checked
                            class="w-3 h-3 rounded"
                            onchange="applyFilters()"
                        />
                        <span>Bash</span>
                    </label>
                    <label
                        class="flex items-center gap-1 cursor-pointer text-gray-600"
                    >
                        <input
                            type="checkbox"
                            id="filter-other"
                            checked
                            class="w-3 h-3 rounded"
                            onchange="applyFilters()"
                        />
                        <span>Other</span>
                    </label>
                </div>

                <!-- Steps List -->
                <div class="bg-white rounded-lg border border-gray-200">
                    <div
                        class="px-3 py-2 border-b border-gray-100 flex items-center justify-between"
                    >
                        <span class="text-xs font-medium text-gray-600"
                            >Steps</span
                        >
                        <span id="step-count" class="text-xs text-gray-400"
                            >0</span
                        >
                    </div>
                    <div id="steps-container" class="space-y-2 p-3">
                        <div class="text-gray-400 text-center py-8 text-xs">
                            Load trajectory to view steps
                        </div>
                    </div>
                </div>
            </section>

            <!-- Empty State -->
            <section id="empty-state" class="text-center py-12">
                <p class="text-sm text-gray-400">
                    Loading trajectory...
                </p>
            </section>
            </div><!-- Close max-w-7xl container -->
        </main>

        <script>
            function toggleMobileMenu() {
                const menu = document.getElementById('mobile-menu');
                const icon = document.getElementById('menu-icon');
                menu.classList.toggle('hidden');
                icon.classList.toggle('fa-bars');
                icon.classList.toggle('fa-times');
            }

            let stepsA = [];
            let stepsB = [];
            let allSteps = [];
            let timeRange = { start: 0, end: 0, duration: 0 };
            let causeIndex = null;

            // Load cause index on page load
            async function initCauseIndex() {
                try {
                    const response = await fetch(
                        "static/data/causes/index.json",
                    );
                    causeIndex = await response.json();

                    // Update counts
                    document.getElementById("count-expectation").textContent =
                        `(${causeIndex.expectation?.length || 0})`;
                    document.getElementById("count-communication").textContent =
                        `(${causeIndex.communication?.length || 0})`;
                    document.getElementById("count-commitment").textContent =
                        `(${causeIndex.commitment?.length || 0})`;
                    
                    // Check for URL params first
                    const urlParams = new URLSearchParams(window.location.search);
                    const model = urlParams.get('model');
                    const repo = urlParams.get('repo');
                    const task = urlParams.get('task');
                    const features = urlParams.get('features');
                    
                    if (model && repo && task && features) {
                        // Load specific trajectory from URL params
                        loadTrajectoryFromParams(model, repo, task, features);
                    } else {
                        // Auto-load a default trajectory
                        loadRandomExample('expectation');
                    }
                } catch (e) {
                    console.error("Error loading cause index:", e);
                }
            }
            
            async function loadTrajectoryFromParams(model, repo, task, features) {
                const trajectoryPath = `static/data/coop/trajectories/${model}/${repo}_${task}_${features}.json.gz`;
                
                showStatus(`Loading ${model} trajectory for ${repo}/${task}/${features}...`, 'info');
                
                try {
                    const response = await fetch(trajectoryPath);
                    if (!response.ok) {
                        throw new Error(`Trajectory not found: ${response.status}`);
                    }
                    // Decompress gzipped data
                    const compressed = await response.arrayBuffer();
                    const decompressed = pako.ungzip(new Uint8Array(compressed), { to: 'string' });
                    const data = JSON.parse(decompressed);
                    
                    // Data is array of steps with agentId field
                    stepsA = [];
                    stepsB = [];
                    
                    // Filter out system prompt steps
                    const isSystemPrompt = (step) => {
                        const content = step.content || step.text || step.message || '';
                        if (typeof content !== 'string') return false;
                        
                        // Skip OpenHands system prompts
                        if (content.includes('You are OpenHands agent')) return true;
                        if (content.includes('<ROLE>')) return true;
                        if (content.includes('You are agent_')) return true;
                        if (content.includes('**FEATURE DESCRIPTION**')) return true;
                        if (content.includes('Added workspace context')) return true;
                        
                        return false;
                    };
                    
                    data.forEach((step, idx) => {
                        // Skip system prompts
                        if (isSystemPrompt(step)) return;
                        
                        if (step.agentId === "agent_1" || step.agent === "A") {
                            stepsA.push({
                                ...step,
                                originalIndex: stepsA.length,
                            });
                        } else {
                            stepsB.push({
                                ...step,
                                originalIndex: stepsB.length,
                            });
                        }
                    });
                    
                    // Update header
                    const modelNames = {
                        gpt5: 'GPT-5',
                        claude: 'Claude Sonnet 4.5',
                        minimax: 'MiniMax M2',
                        qwen_coder: 'Qwen3-Coder-30B',
                        qwen: 'Qwen3-30B'
                    };
                    const modelName = modelNames[model] || model;
                    showStatus(
                        `${modelName}: ${repo.replace(/_/g, ' ')} / ${task} / ${features} (${stepsA.length + stepsB.length} steps)`,
                        "success",
                    );
                    
                    processAndRender();
                } catch (e) {
                    console.error("Error loading trajectory:", e);
                    showStatus(
                        `Trajectory not available: ${repo}/${task}/${features}. Try loading a cause example instead.`,
                        "error",
                    );
                    // Fall back to random example
                    loadRandomExample('expectation');
                }
            }

            async function loadRandomExample(cause) {
                const examples = causeIndex?.[cause] || [];
                if (examples.length === 0) {
                    showStatus("No examples available for this cause", "error");
                    return;
                }

                // Pick random example
                const example =
                    examples[Math.floor(Math.random() * examples.length)];
                if (!example.trajectory_url) {
                    showStatus("Trajectory file not found", "error");
                    return;
                }

                try {
                    const response = await fetch(example.trajectory_url);
                    const data = await response.json();

                    // Data is array of steps with agentId field
                    stepsA = [];
                    stepsB = [];
                    
                    // Filter out system prompt steps
                    const isSystemPrompt = (step) => {
                        const content = step.content || step.text || step.message || '';
                        if (typeof content !== 'string') return false;
                        if (content.includes('You are OpenHands agent')) return true;
                        if (content.includes('<ROLE>')) return true;
                        if (content.includes('You are agent_')) return true;
                        if (content.includes('**FEATURE DESCRIPTION**')) return true;
                        if (content.includes('Added workspace context')) return true;
                        return false;
                    };

                    data.forEach((step, idx) => {
                        // Skip system prompts
                        if (isSystemPrompt(step)) return;
                        
                        if (step.agentId === "agent_1") {
                            stepsA.push({
                                ...step,
                                originalIndex: stepsA.length,
                            });
                        } else {
                            stepsB.push({
                                ...step,
                                originalIndex: stepsB.length,
                            });
                        }
                    });

                    // Show info with cause type
                    const causeLabel =
                        cause.charAt(0).toUpperCase() + cause.slice(1);
                    showStatus(
                        `${causeLabel}: ${example.project.replace(/_/g, " ")} (${stepsA.length + stepsB.length} steps)`,
                        "success",
                    );

                    processAndRender();
                } catch (e) {
                    console.error("Error loading trajectory:", e);
                    showStatus(
                        "Error loading trajectory: " + e.message,
                        "error",
                    );
                }
            }

            window.addEventListener("load", initCauseIndex);

            // Tool type classification
            function getToolType(step) {
                const toolName =
                    step.tool_call_metadata?.function_name ||
                    step.toolName ||
                    "";
                const action = step.action || "";
                const args = step.args || {};

                if (toolName === "finish") return "submit";
                if (
                    toolName === "openhands_comm_send" ||
                    toolName === "openhands_comm_get"
                )
                    return "communication";
                if (toolName === "task_tracker") return "task_tracking";
                if (toolName === "think") return "think";

                if (toolName === "execute_bash") {
                    const cmd = (args.command || "").toLowerCase();
                    if (
                        cmd.includes("grep") ||
                        cmd.includes("find ") ||
                        cmd.includes("locate")
                    ) {
                        return "find_grep";
                    }
                    return "bash";
                }

                if (toolName === "str_replace_editor") {
                    const cmd = args.command;
                    if (cmd === "view") return "view";
                    if (cmd === "create") return "create";
                    return "edit";
                }

                return "other";
            }

            function getToolColor(toolType) {
                const colors = {
                    bash: "bg-yellow-400",
                    find_grep: "bg-sky-300",
                    view: "bg-blue-600",
                    edit: "bg-green-500",
                    create: "bg-green-700",
                    communication: "bg-orange-400",
                    task_tracking: "bg-purple-400",
                    submit: "bg-red-500",
                    think: "bg-gray-400",
                    recall: "bg-indigo-400",
                    condensation: "bg-pink-400",
                    message: "bg-teal-400",
                    other: "bg-gray-300",
                };
                return colors[toolType] || "bg-gray-300";
            }

            function getToolIcon(toolType) {
                const icons = {
                    bash: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
                    find_grep: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>`,
                    view: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>`,
                    edit: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>`,
                    create: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>`,
                    communication: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>`,
                    task_tracking: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`,
                    think: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>`,
                    recall: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path></svg>`,
                    other: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>`,
                };
                return icons[toolType] || icons.other;
            }

            function getToolLabel(toolType) {
                const labels = {
                    bash: "Bash",
                    find_grep: "Find",
                    view: "View",
                    edit: "Edit",
                    create: "Create",
                    communication: "Comm",
                    task_tracking: "Task",
                    submit: "Submit",
                    think: "Think",
                    recall: "Recall",
                    condensation: "Condense",
                    message: "Msg",
                    other: "Other",
                };
                return labels[toolType] || "Unknown";
            }

            function getPillStyle(toolType) {
                // Subtle muted tints - not bright, just hints of color
                const styles = {
                    bash: "bg-amber-50 text-amber-700",
                    find_grep: "bg-sky-50 text-sky-700",
                    view: "bg-blue-50 text-blue-700",
                    edit: "bg-emerald-50 text-emerald-700",
                    create: "bg-emerald-50 text-emerald-700",
                    communication: "bg-orange-50 text-orange-700",
                    task_tracking: "bg-violet-50 text-violet-700",
                    submit: "bg-rose-50 text-rose-700",
                    think: "bg-gray-100 text-gray-600",
                    recall: "bg-indigo-50 text-indigo-700",
                    condensation: "bg-pink-50 text-pink-700",
                    message: "bg-teal-50 text-teal-700",
                    other: "bg-gray-100 text-gray-600",
                };
                return styles[toolType] || "bg-gray-100 text-gray-600";
            }

            function formatTimestamp(ts) {
                try {
                    const d = new Date(ts);
                    return d.toLocaleTimeString("en-US", {
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit",
                        hour12: false,
                    });
                } catch {
                    return ts;
                }
            }

            function formatDuration(ms) {
                if (ms < 1000) return ms + "ms";
                if (ms < 60000) return (ms / 1000).toFixed(1) + "s";
                return (ms / 60000).toFixed(1) + "m";
            }

            function shouldShowStep(step) {
                if (step.action === "system" || step.source === "user")
                    return false;
                
                // Filter out system prompts
                const content = step.content || step.text || step.message || '';
                if (typeof content === 'string') {
                    if (content.includes('You are OpenHands agent')) return false;
                    if (content.includes('<ROLE>')) return false;
                    if (content.includes('You are agent_')) return false;
                    if (content.includes('**FEATURE DESCRIPTION**')) return false;
                    if (content.includes('Added workspace context')) return false;
                }
                
                return true;
            }

            async function loadFromFiles() {
                const fileA = document.getElementById("file-agent-a").files[0];
                const fileB = document.getElementById("file-agent-b").files[0];

                if (!fileA && !fileB) {
                    showStatus("Please select at least one file", "error");
                    return;
                }

                try {
                    if (fileA) {
                        const textA = await fileA.text();
                        stepsA = JSON.parse(textA).filter(shouldShowStep);
                    } else {
                        stepsA = [];
                    }

                    if (fileB) {
                        const textB = await fileB.text();
                        stepsB = JSON.parse(textB).filter(shouldShowStep);
                    } else {
                        stepsB = [];
                    }

                    processAndRender();
                    showStatus(
                        `Loaded ${stepsA.length} + ${stepsB.length} steps`,
                        "success",
                    );
                } catch (e) {
                    showStatus("Error parsing JSON: " + e.message, "error");
                }
            }

            function loadFromPaste() {
                const input = document
                    .getElementById("json-input")
                    .value.trim();
                if (!input) {
                    showStatus("Please paste JSON data", "error");
                    return;
                }

                try {
                    const data = JSON.parse(input);

                    if (data.stepsA && data.stepsB) {
                        stepsA = data.stepsA.filter(shouldShowStep);
                        stepsB = data.stepsB.filter(shouldShowStep);
                    } else if (Array.isArray(data)) {
                        // Single array - try to split by agentId
                        const agents = {};
                        data.forEach((step) => {
                            const id = step.agentId || "A";
                            if (!agents[id]) agents[id] = [];
                            agents[id].push(step);
                        });
                        const keys = Object.keys(agents).sort();
                        stepsA = (agents[keys[0]] || []).filter(shouldShowStep);
                        stepsB = (agents[keys[1]] || []).filter(shouldShowStep);
                    } else {
                        throw new Error(
                            "Invalid format. Expected {stepsA, stepsB} or array with agentId",
                        );
                    }

                    processAndRender();
                    showStatus(
                        `Loaded ${stepsA.length} + ${stepsB.length} steps`,
                        "success",
                    );
                } catch (e) {
                    showStatus("Error parsing JSON: " + e.message, "error");
                }
            }

            function processAndRender() {
                // Combine and sort steps
                allSteps = [
                    ...stepsA.map((s, i) => ({
                        ...s,
                        agent: "A",
                        originalIndex: i,
                    })),
                    ...stepsB.map((s, i) => ({
                        ...s,
                        agent: "B",
                        originalIndex: i,
                    })),
                ];

                // Sort by timestamp
                allSteps.sort((a, b) => {
                    const tA = new Date(a.timestamp || a.timestampMs).getTime();
                    const tB = new Date(b.timestamp || b.timestampMs).getTime();
                    return tA - tB;
                });

                // Calculate time range
                if (allSteps.length > 0) {
                    const times = allSteps
                        .map((s) =>
                            new Date(s.timestamp || s.timestampMs).getTime(),
                        )
                        .filter((t) => !isNaN(t));
                    timeRange.start = Math.min(...times);
                    timeRange.end = Math.max(...times);
                    timeRange.duration = timeRange.end - timeRange.start || 1;
                }

                // Update stats
                document.getElementById("stats-agent-a").textContent =
                    stepsA.length;
                document.getElementById("stats-agent-b").textContent =
                    stepsB.length;
                document.getElementById("stats-duration").textContent =
                    formatDuration(timeRange.duration);

                // Show viewer
                document
                    .getElementById("viewer-section")
                    .classList.remove("hidden");
                document.getElementById("empty-state").classList.add("hidden");

                renderTimeline();
                renderSteps();
            }

            function renderTimeline() {
                const timelineA = document.getElementById("timeline-a");
                const timelineB = document.getElementById("timeline-b");
                timelineA.innerHTML = "";
                timelineB.innerHTML = "";

                function renderAgent(steps, container, agent) {
                    // Filter out comm_get steps
                    const filteredSteps = steps.filter(step => {
                        const toolName = step.toolName || step.tool_call_metadata?.function_name || "";
                        return !toolName.includes("comm_get") && !toolName.includes("receive");
                    });
                    
                    filteredSteps.forEach((step, idx) => {
                        const ts = new Date(
                            step.timestamp || step.timestampMs,
                        ).getTime();
                        if (isNaN(ts)) return;

                        const left =
                            ((ts - timeRange.start) / timeRange.duration) * 100;
                        const toolType = step.toolType || getToolType(step);

                        // Calculate width: extend to next step's start time (or end of timeline)
                        let nextTs = timeRange.end;
                        if (idx < filteredSteps.length - 1) {
                            nextTs = new Date(filteredSteps[idx + 1].timestamp || filteredSteps[idx + 1].timestampMs).getTime();
                        }
                        const widthPct = Math.max(((nextTs - ts) / timeRange.duration) * 100, 0.5);

                        const block = document.createElement("div");
                        block.className = `absolute top-0 h-full ${getToolColor(toolType)} timeline-block cursor-pointer`;
                        block.style.left = `${Math.min(left, 99.5)}%`;
                        block.style.width = `${Math.min(widthPct, 100 - left)}%`;
                        block.style.minWidth = "2px";
                        block.title = `${formatTimestamp(step.timestamp || step.timestampMs)}: ${getToolLabel(toolType)}`;

                        const globalIdx = allSteps.findIndex(
                            (s) => s.agent === agent && s.originalIndex === idx,
                        );
                        block.onclick = () => scrollToStep(globalIdx);

                        container.appendChild(block);
                    });
                }

                renderAgent(stepsA, timelineA, "A");
                renderAgent(stepsB, timelineB, "B");

                // Time markers
                const markers = document.getElementById("time-markers");
                markers.innerHTML = "";
                if (timeRange.duration > 0) {
                    [0, 25, 50, 75, 100].forEach((pct) => {
                        const t =
                            timeRange.start + (timeRange.duration * pct) / 100;
                        const span = document.createElement("span");
                        span.textContent = formatTimestamp(
                            new Date(t).toISOString(),
                        );
                        markers.appendChild(span);
                    });
                }
            }

            function renderSteps() {
                const container = document.getElementById("steps-container");
                container.innerHTML = "";

                const filters = {
                    comm: document.getElementById("filter-comm").checked,
                    edit: document.getElementById("filter-edit").checked,
                    view: document.getElementById("filter-view").checked,
                    bash: document.getElementById("filter-bash").checked,
                    other: document.getElementById("filter-other").checked,
                };

                let visibleCount = 0;

                allSteps.forEach((step, idx) => {
                    const toolType = step.toolType || getToolType(step);

                    // Skip comm_get (receive) actions - they just check for messages
                    const toolName = step.toolName || step.tool_call_metadata?.function_name || "";
                    if (toolName.includes("comm_get") || toolName.includes("receive")) return;

                    // Apply filters
                    if (toolType === "communication" && !filters.comm) return;
                    if (
                        (toolType === "edit" || toolType === "create") &&
                        !filters.edit
                    )
                        return;
                    if (toolType === "view" && !filters.view) return;
                    if (
                        (toolType === "bash" || toolType === "find_grep") &&
                        !filters.bash
                    )
                        return;
                    if (
                        [
                            "submit",
                            "task_tracking",
                            "think",
                            "ipython",
                            "other",
                            "recall",
                            "condensation",
                            "message",
                        ].includes(toolType) &&
                        !filters.other
                    )
                        return;

                    visibleCount++;
                    const isA = step.agent === "A";

                    const div = document.createElement("div");
                    div.id = `step-${idx}`;
                    div.className = `flex ${isA ? "justify-start" : "justify-end"} scroll-mt-32`;

                    // Build content - always show expanded, no interior scrolling
                    let contentHtml = "";

                    // For communication, show the message details (collapsible if long)
                    // Check multiple possible fields for the message content (send vs receive have different structures)
                    const commMessage = step.details || step.args?.message || step.args?.content || step.message || step.result || step.observation || step.response || step.received || "";
                    if (toolType === "communication" && commMessage) {
                        let formatted = escapeHtml(commMessage);
                        formatted = formatted.replace(
                            /\*\*(.*?)\*\*/g,
                            "<strong>$1</strong>",
                        );
                        formatted = formatted.replace(
                            /`([^`]+)`/g,
                            '<code class="bg-gray-200 px-1 rounded text-xs">$1</code>',
                        );
                        formatted = formatted.replace(/\n/g, "<br>");
                        const isLong = commMessage.length > 300;
                        const contentId = `content-${idx}`;
                        contentHtml = `
                            <div class="text-xs text-gray-600 leading-relaxed mt-1.5 break-words">
                                <div id="${contentId}" class="${isLong ? 'max-h-24 overflow-hidden' : ''}">${formatted}</div>
                                ${isLong ? `<button onclick="toggleExpand('${contentId}', this)" class="text-gray-400 hover:text-gray-600 text-[10px] mt-1">Show more ↓</button>` : ''}
                            </div>`;
                    } else if (toolType === "communication") {
                        // Different placeholder based on send vs receive
                        const toolName = step.toolName || step.tool_call_metadata?.function_name || "";
                        if (toolName.includes("get") || toolName.includes("receive")) {
                            contentHtml = `<div class="text-xs text-gray-400 italic mt-1.5">Checked for messages</div>`;
                        } else {
                            contentHtml = `<div class="text-xs text-gray-400 italic mt-1.5">(message content not available)</div>`;
                        }
                    }

                    // For bash/find_grep, show command (light mode)
                    if ((toolType === "bash" || toolType === "find_grep") && step.args?.command) {
                        contentHtml = `<div class="mt-1.5 text-xs font-mono bg-gray-100 text-gray-800 p-2 rounded border border-gray-200 whitespace-pre-wrap break-all">${escapeHtml(step.args.command)}</div>`;
                    }

                    // For view, show file path
                    if (toolType === "view" && step.args?.path) {
                        contentHtml = `<div class="mt-1.5 text-xs text-gray-600 break-all"><span class="text-gray-400">file:</span> ${escapeHtml(step.args.path)}</div>`;
                    }

                    // For edit, show file path and changes (git-style diff, collapsible if long)
                    if (toolType === "edit" && step.args) {
                        let editContent = "";
                        if (step.args.path) {
                            editContent += `<div class="text-gray-600 font-mono text-[10px] break-all">${escapeHtml(step.args.path)}</div>`;
                        }
                        if (step.args.old_str || step.args.new_str) {
                            const totalLines = (step.args.old_str?.split('\n').length || 0) + (step.args.new_str?.split('\n').length || 0);
                            const isLong = totalLines > 15;
                            const contentId = `diff-${idx}`;
                            
                            editContent += `<div id="${contentId}" class="mt-1.5 font-mono text-[10px] bg-gray-50 border border-gray-200 rounded overflow-hidden leading-tight ${isLong ? 'max-h-48' : ''}">`;
                            if (step.args.old_str) {
                                const oldLines = escapeHtml(step.args.old_str.slice(0, 1000)).split('\n');
                                editContent += oldLines.map(line => 
                                    `<div class="px-2 bg-red-50/30"><span class="text-red-500 select-none">-</span> <span class="text-gray-700">${line}</span></div>`
                                ).join('');
                                if (step.args.old_str.length > 1000) editContent += `<div class="px-2 text-gray-400">...</div>`;
                            }
                            if (step.args.new_str) {
                                const newLines = escapeHtml(step.args.new_str.slice(0, 1000)).split('\n');
                                editContent += newLines.map(line => 
                                    `<div class="px-2 bg-green-50/30"><span class="text-green-600 select-none">+</span> <span class="text-gray-700">${line}</span></div>`
                                ).join('');
                                if (step.args.new_str.length > 1000) editContent += `<div class="px-2 text-gray-400">...</div>`;
                            }
                            editContent += `</div>`;
                            if (isLong) {
                                editContent += `<button onclick="toggleExpand('${contentId}', this)" class="text-gray-400 hover:text-gray-600 text-[10px] mt-1">Show more ↓</button>`;
                            }
                        }
                        if (editContent) {
                            contentHtml = `<div class="mt-1.5">${editContent}</div>`;
                        }
                    }

                    // For think, show the thought
                    if (toolType === "think" && step.args?.thought) {
                        contentHtml = `<div class="mt-1.5 text-xs text-gray-600 italic break-words">${escapeHtml(step.args.thought.slice(0, 300))}${step.args.thought.length > 300 ? "..." : ""}</div>`;
                    }

                    // For submit/finish, show as a completion indicator
                    if (toolType === "submit") {
                        const submitMsg = step.args?.message || step.args?.final_thought || "";
                        contentHtml = `
                            <div class="mt-1.5 flex items-start gap-2">
                                <div class="flex-shrink-0 w-5 h-5 rounded-full bg-emerald-100 flex items-center justify-center">
                                    <svg class="w-3 h-3 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <div class="text-xs text-gray-600">
                                    <span class="font-medium text-emerald-700">Task completed</span>
                                    ${submitMsg ? `<p class="mt-0.5 text-gray-500">${escapeHtml(submitMsg.slice(0, 200))}${submitMsg.length > 200 ? "..." : ""}</p>` : ""}
                                </div>
                            </div>`;
                    }

                    // For recall, show query
                    if (toolType === "recall" && step.args?.query) {
                        contentHtml = `<div class="mt-1.5 text-xs text-gray-500 italic break-words">Recalling: ${escapeHtml(step.args.query.slice(0, 200))}...</div>`;
                    }

                    // For task_tracking, show task summary and list
                    if (toolType === "task_tracking" && step.args?.task_list) {
                        const tasks = step.args.task_list;
                        const done = tasks.filter(t => t.status === 'done').length;
                        const inProgress = tasks.filter(t => t.status === 'in_progress').length;
                        const todo = tasks.filter(t => t.status === 'todo').length;
                        const taskListId = `tasks-${idx}`;
                        
                        let taskListHtml = tasks.map(t => {
                            const statusIcon = t.status === 'done' ? '✓' : t.status === 'in_progress' ? '→' : '○';
                            const statusColor = t.status === 'done' ? 'text-green-600' : t.status === 'in_progress' ? 'text-yellow-600' : 'text-gray-400';
                            return `<div class="flex items-start gap-1.5"><span class="${statusColor}">${statusIcon}</span><span class="text-gray-600">${escapeHtml(t.title || t.id)}</span></div>`;
                        }).join('');
                        
                        contentHtml = `
                            <div class="mt-1.5 text-xs">
                                <div class="text-gray-500">${tasks.length} tasks: <span class="text-green-600">${done} done</span>, <span class="text-yellow-600">${inProgress} in progress</span>, <span class="text-gray-400">${todo} todo</span></div>
                                <div id="${taskListId}" class="mt-1.5 space-y-0.5 max-h-0 overflow-hidden">${taskListHtml}</div>
                                <button onclick="toggleTaskList('${taskListId}', this)" class="text-gray-400 hover:text-gray-600 text-[10px] mt-1">Show tasks ↓</button>
                            </div>`;
                    }

                    // For create, show file path
                    if (toolType === "create" && step.args?.path) {
                        contentHtml = `<div class="mt-1.5 text-xs text-gray-600 font-mono break-all">${escapeHtml(step.args.path)}</div>`;
                    }

                    // For message type, try to find content
                    if (toolType === "message") {
                        const msgContent = step.args?.content || step.args?.message || step.content || step.message || step.details || "";
                        if (msgContent) {
                            contentHtml = `<div class="mt-1.5 text-xs text-gray-600 break-words">${escapeHtml(msgContent.slice(0, 300))}${msgContent.length > 300 ? "..." : ""}</div>`;
                        }
                    }

                    // For condensation, show summary
                    if (toolType === "condensation") {
                        const summary = step.args?.summary || step.summary || "";
                        if (summary) {
                            contentHtml = `<div class="mt-1.5 text-xs text-gray-500 italic break-words">${escapeHtml(summary.slice(0, 200))}${summary.length > 200 ? "..." : ""}</div>`;
                        } else {
                            contentHtml = `<div class="mt-1.5 text-xs text-gray-400 italic">Context condensed</div>`;
                        }
                    }

                    // For other/unknown types, try to show any available content
                    if (toolType === "other" && !contentHtml) {
                        const anyContent = step.args?.content || step.args?.message || step.details || step.content || "";
                        if (anyContent) {
                            contentHtml = `<div class="mt-1.5 text-xs text-gray-600 break-words">${escapeHtml(String(anyContent).slice(0, 200))}${String(anyContent).length > 200 ? "..." : ""}</div>`;
                        }
                    }

                    // Subtle color accents for agents
                    const labelColor = isA ? "text-red-400" : "text-blue-400";

                    // Special card for Submit - no agent label or pill
                    if (toolType === "submit") {
                        div.innerHTML = `
                        <div class="max-w-[85%]">
                            <div class="step-card px-3 py-2 bg-white rounded border border-gray-200">
                                ${contentHtml}
                                <div class="text-[10px] text-gray-400 mt-1">${formatTimestamp(step.timestamp || step.timestampMs)}</div>
                            </div>
                        </div>
                        `;
                    } else {
                        div.innerHTML = `
                        <div class="max-w-[85%]">
                            <div class="step-card px-3 py-2 bg-white rounded border border-gray-200">
                                <div class="flex items-center gap-2 text-[11px]">
                                    <span class="font-medium ${labelColor}">${isA ? "A" : "B"}</span>
                                    <span class="px-1.5 py-0.5 rounded text-[10px] flex items-center gap-1 ${getPillStyle(toolType)}">${getToolIcon(toolType)}${getToolLabel(toolType)}</span>
                                    <span class="text-gray-400 ml-auto">${formatTimestamp(step.timestamp || step.timestampMs)}</span>
                                </div>
                                ${contentHtml}
                            </div>
                        </div>
                        `;
                    }

                    container.appendChild(div);
                });

                document.getElementById("step-count").textContent =
                    `${visibleCount} of ${allSteps.length}`;

                if (visibleCount === 0) {
                    container.innerHTML =
                        '<div class="text-gray-400 text-center py-8 text-sm">No steps match filters</div>';
                }
            }

            function applyFilters() {
                renderSteps();
            }

            function scrollToStep(idx) {
                const el = document.getElementById(`step-${idx}`);
                if (el) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    el.classList.add("highlight-ring", "bg-yellow-50");
                    setTimeout(() => {
                        el.classList.remove("highlight-ring", "bg-yellow-50");
                    }, 1500);
                }
            }

            function clearViewer() {
                stepsA = [];
                stepsB = [];
                allSteps = [];
                document
                    .getElementById("viewer-section")
                    .classList.add("hidden");
                document
                    .getElementById("empty-state")
                    .classList.remove("hidden");
                document.getElementById("file-agent-a").value = "";
                document.getElementById("file-agent-b").value = "";
                document.getElementById("json-input").value = "";
                document.getElementById("load-status").classList.add("hidden");
            }

            function showStatus(msg, type) {
                const el = document.getElementById("load-status");
                el.textContent = msg;
                el.className = `mt-4 text-sm ${type === "error" ? "text-red-600" : "text-green-600"}`;
                el.classList.remove("hidden");
            }

            function escapeHtml(str) {
                if (str == null) return '';
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            }

            function toggleExpand(contentId, btn) {
                const el = document.getElementById(contentId);
                if (el.classList.contains('max-h-24') || el.classList.contains('max-h-48')) {
                    el.classList.remove('max-h-24', 'max-h-48');
                    btn.textContent = 'Show less ↑';
                } else {
                    // Restore the appropriate max-height based on content type
                    if (contentId.startsWith('diff-')) {
                        el.classList.add('max-h-48');
                    } else {
                        el.classList.add('max-h-24');
                    }
                    btn.textContent = 'Show more ↓';
                }
            }

            function toggleTaskList(taskListId, btn) {
                const el = document.getElementById(taskListId);
                if (el.classList.contains('max-h-0')) {
                    el.classList.remove('max-h-0');
                    el.classList.add('max-h-96');
                    btn.textContent = 'Hide tasks ↑';
                } else {
                    el.classList.remove('max-h-96');
                    el.classList.add('max-h-0');
                    btn.textContent = 'Show tasks ↓';
                }
            }
        </script>
    </body>
</html>
