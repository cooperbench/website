<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tasks · CooperBench</title>
    <meta name="description" content="Browse 199 collaborative coding features across 12 repositories" />
    <link rel="icon" type="image/svg+xml" href="static/images/favicon.svg?v=2" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.16.0/devicon.min.css" />
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Nebula Sans', 'system-ui', 'sans-serif'],
                        mono: ['SF Mono', 'Monaco', 'Consolas', 'monospace'],
                    },
                },
            },
        };
    </script>
    
    <style>
        @font-face { font-family: "Nebula Sans"; src: url("static/fonts/NebulaSans-Light.woff2") format("woff2"); font-weight: 300; font-display: swap; }
        @font-face { font-family: "Nebula Sans"; src: url("static/fonts/NebulaSans-Book.woff2") format("woff2"); font-weight: 400; font-display: swap; }
        @font-face { font-family: "Nebula Sans"; src: url("static/fonts/NebulaSans-Medium.woff2") format("woff2"); font-weight: 500; font-display: swap; }
        @font-face { font-family: "Nebula Sans"; src: url("static/fonts/NebulaSans-Semibold.woff2") format("woff2"); font-weight: 600; font-display: swap; }
        @font-face { font-family: "Nebula Sans"; src: url("static/fonts/NebulaSans-Bold.woff2") format("woff2"); font-weight: 700; font-display: swap; }
        body, .font-sans, h1, h2, h3, h4, h5, h6 { font-family: "Nebula Sans", system-ui, sans-serif !important; }
        .task-card { transition: box-shadow 0.15s ease, border-color 0.15s ease; }
        .task-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #d1d5db; }
        .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-4 { display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }
        
        /* Side panel */
        .side-panel { transform: translateX(calc(100% + 1rem)); transition: transform 0.25s ease-out; }
        .side-panel.open { transform: translateX(0); }
        .backdrop { opacity: 0; transition: opacity 0.25s ease-out; pointer-events: none; }
        .backdrop.open { opacity: 1; pointer-events: auto; }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 overflow-y-scroll">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur border-b border-gray-200 z-50">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex items-center justify-between h-14">
                <a href="index.html" class="flex items-center gap-2 text-lg font-semibold text-gray-900">
                    <img src="static/images/favicon.svg" alt="" class="w-5 h-5" style="filter: brightness(0);">
                    CooperBench
                </a>
                <nav class="flex items-center gap-6">
                    <a href="leaderboard.html" class="text-sm text-gray-600 hover:text-gray-900">Leaderboard</a>
                    <a href="tasks.html" class="text-sm text-gray-900 font-medium">Tasks</a>
                    <a href="viewer.html" class="text-sm text-gray-600 hover:text-gray-900">Trajectories</a>
                    <a href="blog.html" class="text-sm text-gray-600 hover:text-gray-900">Blog</a>
                    <a href="https://arxiv.org/abs/2601.13295" target="_blank" class="text-sm text-gray-600 hover:text-gray-900">Paper <span class="text-xs">↗</span></a>
                    <a href="https://github.com/cooperbench/CooperBench" target="_blank" class="text-gray-600 hover:text-gray-900"><i class="fab fa-github"></i></a>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-14">
        <!-- Page Header -->
        <div class="bg-white">
            <div class="max-w-7xl mx-auto px-6 py-8">
                <h1 class="text-2xl font-semibold text-gray-900 mb-2">CooperBench Tasks</h1>
                
                <!-- Install command box -->
                <div class="bg-gray-100 border border-gray-200 rounded-lg px-4 py-3 mt-4 flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <code class="text-gray-700 text-sm font-mono">pip install cooperbench</code>
                        <code class="text-gray-700 text-sm font-mono">uv pip install cooperbench</code>
                    </div>
                    <button onclick="copyInstallCommand()" class="text-gray-400 hover:text-gray-600 ml-4" title="Copy install command">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Run Your Own Evaluation Section (Collapsible) -->
        <div class="bg-white">
            <div class="max-w-7xl mx-auto px-6">
                <button onclick="toggleRunEval()" class="w-full flex items-center justify-between py-4 text-left hover:bg-gray-50 transition-colors rounded-lg">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-medium text-gray-900">Test Your Own Agents</span>
                        <span class="text-xs text-gray-400">— generate a command for any task pair</span>
                    </div>
                    <i id="run-eval-chevron" class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                </button>
                
                <div id="run-eval-content" class="hidden pb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Repository</label>
                            <select id="run-repo-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400">
                                <option value="">Select repository</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Task</label>
                            <select id="run-task-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400" disabled>
                                <option value="">Select task</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Feature 1</label>
                            <select id="run-feature1-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400" disabled>
                                <option value="">Select feature</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Feature 2</label>
                            <select id="run-feature2-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400" disabled>
                                <option value="">Select feature</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Model 1 (Agent 1)</label>
                            <select id="run-model1-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400">
                                <option value="anthropic/claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                                <option value="anthropic/claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                <option value="openai/gpt-4.1">GPT-4.1</option>
                                <option value="openai/o3">o3</option>
                                <option value="openai/o4-mini">o4-mini</option>
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro</option>
                                <option value="deepseek/deepseek-v3">DeepSeek V3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Model 2 (Agent 2)</label>
                            <select id="run-model2-select" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none focus:border-gray-400">
                                <option value="anthropic/claude-sonnet-4-5-20250929">Claude Sonnet 4.5</option>
                                <option value="anthropic/claude-sonnet-4-20250514">Claude Sonnet 4</option>
                                <option value="openai/gpt-4.1">GPT-4.1</option>
                                <option value="openai/o3">o3</option>
                                <option value="openai/o4-mini">o4-mini</option>
                                <option value="google/gemini-2.5-pro">Gemini 2.5 Pro</option>
                                <option value="deepseek/deepseek-v3">DeepSeek V3</option>
                            </select>
                        </div>
                    </div>

                    <div id="run-command-box" class="bg-gray-100 border border-gray-200 rounded-lg p-4 hidden">
                        <div class="flex items-start justify-between gap-4">
                            <pre id="run-command-output" class="text-gray-700 text-sm font-mono whitespace-pre-wrap break-all flex-1"></pre>
                            <button onclick="copyRunCommand()" class="text-gray-400 hover:text-gray-600 text-sm flex items-center gap-1 flex-shrink-0" title="Copy command">
                                <i class="far fa-copy"></i>
                                <span id="copy-run-text">Copy</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters Bar -->
        <div class="bg-white sticky top-14 z-40">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between mb-4">
                    <span id="task-count" class="text-sm text-gray-600">Showing 199 features</span>
                    <button onclick="clearFilters()" class="text-sm text-gray-500 hover:text-gray-700">Clear filters</button>
                </div>
                
                <div class="flex flex-wrap gap-3">
                    <div class="flex-1 min-w-[200px] max-w-md">
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Search tasks" 
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:border-gray-400 bg-white"
                        />
                    </div>
                    <select id="repo-filter" class="px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none min-w-[160px]">
                        <option value="">Select repository</option>
                    </select>
                    <select id="lang-filter" class="px-3 py-2 text-sm border border-gray-200 rounded-lg bg-white focus:outline-none min-w-[140px]">
                        <option value="">Select language</option>
                        <option value="python">Python</option>
                        <option value="typescript">TypeScript</option>
                        <option value="go">Go</option>
                        <option value="rust">Rust</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Task Grid -->
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards rendered here -->
            </div>
        </div>
    </main>

    <!-- Side Panel Backdrop -->
    <div id="backdrop" class="backdrop fixed inset-0 bg-black/30 z-[60]" onclick="closePanel()"></div>
    
    <!-- Side Panel -->
    <div id="side-panel" class="side-panel fixed top-4 right-4 bottom-4 w-full max-w-xl bg-white z-[70] shadow-2xl rounded-xl flex flex-col">
        <div id="panel-content" class="flex flex-col h-full"></div>
    </div>

    <script>
        let allTasks = [];
        let allFeatures = [];

        const langConfig = {
            python: { icon: "devicon-python-plain", color: "text-[#3776AB]" },
            typescript: { icon: "devicon-typescript-plain", color: "text-[#3178C6]" },
            go: { icon: "devicon-go-original-wordmark", color: "text-[#00ADD8]" },
            rust: { icon: "devicon-rust-original", color: "text-[#000000]" }
        };

        async function loadTasks() {
            try {
                const response = await fetch('static/data/tasks.json');
                allTasks = await response.json();
                
                // Flatten to features for card display
                allFeatures = [];
                allTasks.forEach(task => {
                    task.features.forEach(feature => {
                        allFeatures.push({
                            ...feature,
                            repo: task.repo,
                            repoUrl: task.repoUrl,
                            repoKey: task.repoKey,
                            taskId: task.taskId,
                            language: task.language
                        });
                    });
                });
                
                populateRepoFilter();
                populateRunRepoSelect();
                renderGrid();
            } catch (e) {
                console.error('Error loading tasks:', e);
                document.getElementById('tasks-grid').innerHTML = 
                    '<div class="col-span-3 p-8 text-center text-red-500">Error loading tasks</div>';
            }
        }

        function populateRepoFilter() {
            const repos = [...new Set(allTasks.map(t => t.repo))].sort();
            const select = document.getElementById('repo-filter');
            repos.forEach(repo => {
                const opt = document.createElement('option');
                opt.value = repo;
                opt.textContent = repo;
                select.appendChild(opt);
            });
        }

        function getFilteredFeatures() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const lang = document.getElementById('lang-filter').value;
            const repo = document.getElementById('repo-filter').value;

            return allFeatures.filter(f => {
                if (lang && f.language !== lang) return false;
                if (repo && f.repo !== repo) return false;
                if (search) {
                    const searchIn = [f.repo, f.taskId, f.id, f.title, f.description].join(' ').toLowerCase();
                    if (!searchIn.includes(search)) return false;
                }
                return true;
            });
        }

        function renderGrid() {
            const features = getFilteredFeatures();
            const container = document.getElementById('tasks-grid');
            
            document.getElementById('task-count').textContent = `Showing ${features.length} features`;

            if (features.length === 0) {
                container.innerHTML = '<div class="col-span-3 p-8 text-center text-gray-400">No tasks match your filters</div>';
                return;
            }

            container.innerHTML = features.map((f, idx) => {
                const lang = langConfig[f.language] || { icon: "fas fa-code", color: "text-gray-600" };
                // Extract first paragraph of description
                const descLines = (f.description || '').split('\n').filter(l => l.trim() && !l.startsWith('**') && !l.startsWith('#'));
                const shortDesc = descLines.slice(0, 3).join(' ').substring(0, 200);
                
                const featureGithubUrl = `https://github.com/cooperbench/CooperBench/tree/main/dataset/${f.repoKey}/${f.taskId}/${f.id}`;
                
                return `
                    <div class="task-card bg-white rounded-lg border border-gray-200 p-4 cursor-pointer" onclick="openPanel(${idx})">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-start gap-2">
                                <i class="${lang.icon} ${lang.color} text-lg flex-shrink-0 mt-0.5"></i>
                                <h3 class="font-mono text-sm font-semibold text-gray-900 line-clamp-2">${escapeHtml(f.title)}</h3>
                            </div>
                            <a href="${featureGithubUrl}" target="_blank" onclick="event.stopPropagation()" class="text-xs text-gray-400 hover:text-gray-600 ml-2 flex-shrink-0" title="View on GitHub">
                                <i class="fab fa-github"></i>
                            </a>
                        </div>
                        
                        <p class="text-sm text-gray-600 line-clamp-4 mb-3 leading-relaxed">${escapeHtml(shortDesc)}${shortDesc.length >= 200 ? '...' : ''}</p>
                        
                        <div class="text-xs text-gray-400 pt-2 border-t border-gray-100">
                            ${f.repo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openPanel(idx) {
            const features = getFilteredFeatures();
            const f = features[idx];
            if (!f) return;

            const panel = document.getElementById('side-panel');
            const backdrop = document.getElementById('backdrop');
            const content = document.getElementById('panel-content');
            const lang = langConfig[f.language] || { icon: "fas fa-code", color: "text-gray-600" };
            const featureGithubUrl = `https://github.com/cooperbench/CooperBench/tree/main/dataset/${f.repoKey}/${f.taskId}/${f.id}`;

            content.innerHTML = `
                <div class="px-5 pt-5 pb-3">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <i class="${lang.icon} ${lang.color} text-base"></i>
                            <span class="text-xs text-gray-500">${f.repo}</span>
                            <a href="${featureGithubUrl}" target="_blank" class="text-xs text-gray-400 hover:text-gray-600 flex items-center gap-1">
                                <i class="fab fa-github"></i>
                                <span>View source</span>
                            </a>
                        </div>
                        <button onclick="closePanel()" class="w-6 h-6 flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-400 hover:text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <h2 class="text-sm font-semibold text-gray-900 leading-snug">${escapeHtml(f.title)}</h2>
                </div>
                
                <div class="flex gap-1 px-5 pb-3">
                    <button onclick="showPanelTab('desc', ${idx})" id="ptab-desc" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-900 text-white">Description</button>
                    <button onclick="showPanelTab('patch', ${idx})" id="ptab-patch" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">Gold Patch</button>
                    <button onclick="showPanelTab('tests', ${idx})" id="ptab-tests" class="px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200">Tests</button>
                </div>
                
                <div id="panel-tab-content" class="flex-1 px-5 pb-5 overflow-y-auto">
                    ${renderMarkdown(f.description)}
                </div>
            `;

            panel.classList.add('open');
            backdrop.classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closePanel() {
            const panel = document.getElementById('side-panel');
            const backdrop = document.getElementById('backdrop');
            panel.classList.remove('open');
            backdrop.classList.remove('open');
            document.body.style.overflow = '';
        }

        function showPanelTab(tab, idx) {
            const features = getFilteredFeatures();
            const f = features[idx];
            
            ['desc', 'patch', 'tests'].forEach(t => {
                const btn = document.getElementById(`ptab-${t}`);
                btn.className = t === tab 
                    ? 'px-3 py-1.5 text-xs font-medium rounded-full bg-gray-900 text-white'
                    : 'px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200';
            });

            const content = document.getElementById('panel-tab-content');
            if (tab === 'desc') {
                content.innerHTML = renderMarkdown(f.description);
            } else if (tab === 'patch') {
                content.innerHTML = renderDiff(f.patch, 'feature.patch');
            } else if (tab === 'tests') {
                content.innerHTML = renderDiff(f.tests, 'tests.patch');
            }
        }

        function renderMarkdown(md) {
            if (!md || !md.trim()) return '<div class="text-gray-400 text-xs">No description available</div>';
            
            // Remove the "Title:" line since it's already in the header
            let text = md.replace(/^\*\*Title\*\*:.*$/gm, '').trim();
            
            let html = escapeHtml(text);
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold">$1</strong>');
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre class="bg-gray-100 border border-gray-200 text-gray-800 p-2 rounded overflow-x-auto my-2 text-[10px] font-mono leading-tight">$2</pre>');
            html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-[10px] font-mono">$1</code>');
            html = html.replace(/^### (.+)$/gm, '<h4 class="font-semibold text-gray-900 text-xs mt-3 mb-1">$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3 class="font-semibold text-gray-900 text-xs mt-3 mb-1">$1</h3>');
            html = html.replace(/^# (.+)$/gm, '<h2 class="font-bold text-gray-900 text-sm mt-3 mb-1">$1</h2>');
            // Handle list items - strip existing bullets and normalize, keep on separate lines
            html = html.replace(/^- •\s*(.+)$/gm, '<div class="ml-3 mb-0.5">• $1</div>');
            html = html.replace(/^- (.+)$/gm, '<div class="ml-3 mb-0.5">• $1</div>');
            html = html.replace(/^• (.+)$/gm, '<div class="ml-3 mb-0.5">• $1</div>');
            html = html.replace(/\n\n+/g, '</p><p class="mb-2">');
            
            return `<div class="prose max-w-none text-gray-700 text-xs leading-relaxed"><p class="mb-2">${html}</p></div>`;
        }

        function renderDiff(diff, filename) {
            if (!diff || !diff.trim()) return '<div class="text-gray-400 text-xs">No patch available</div>';
            
            const lines = diff.split('\n').map(line => {
                const escaped = escapeHtml(line);
                if (line.startsWith('+++') || line.startsWith('---') || line.startsWith('diff ')) {
                    return `<span class="text-blue-600">${escaped}</span>`;
                } else if (line.startsWith('+') && !line.startsWith('+++')) {
                    return `<span class="text-green-600">${escaped}</span>`;
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                    return `<span class="text-red-600">${escaped}</span>`;
                } else if (line.startsWith('@@')) {
                    return `<span class="text-purple-600">${escaped}</span>`;
                }
                return `<span class="text-gray-700">${escaped || ' '}</span>`;
            });
            
            return `
                <div class="text-[10px] text-gray-500 mb-1 font-mono">${filename}</div>
                <pre class="bg-gray-100 border border-gray-200 text-[10px] p-2 rounded overflow-x-auto font-mono leading-tight">${lines.join('\n')}</pre>
            `;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('lang-filter').value = '';
            document.getElementById('repo-filter').value = '';
            renderGrid();
        }

        function copyInstallCommand() {
            navigator.clipboard.writeText('pip install cooperbench');
        }

        function toggleRunEval() {
            const content = document.getElementById('run-eval-content');
            const chevron = document.getElementById('run-eval-chevron');
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // Run command generation
        function populateRunRepoSelect() {
            const repos = [...new Set(allTasks.map(t => t.repo))].sort();
            const select = document.getElementById('run-repo-select');
            select.innerHTML = '<option value="">Select repository</option>';
            repos.forEach(repo => {
                const opt = document.createElement('option');
                opt.value = repo;
                opt.textContent = repo;
                select.appendChild(opt);
            });
        }

        function onRunRepoChange() {
            const repo = document.getElementById('run-repo-select').value;
            const taskSelect = document.getElementById('run-task-select');
            const feature1Select = document.getElementById('run-feature1-select');
            const feature2Select = document.getElementById('run-feature2-select');
            
            // Reset downstream selects
            taskSelect.innerHTML = '<option value="">Select task</option>';
            feature1Select.innerHTML = '<option value="">Select feature</option>';
            feature2Select.innerHTML = '<option value="">Select feature</option>';
            feature1Select.disabled = true;
            feature2Select.disabled = true;
            
            if (!repo) {
                taskSelect.disabled = true;
                updateRunCommand();
                return;
            }
            
            // Populate tasks for selected repo
            const tasks = allTasks.filter(t => t.repo === repo);
            tasks.forEach(task => {
                const opt = document.createElement('option');
                opt.value = task.taskId;
                opt.textContent = `${task.taskId} (${task.features.length} features)`;
                taskSelect.appendChild(opt);
            });
            taskSelect.disabled = false;
            updateRunCommand();
        }

        function onRunTaskChange() {
            const repo = document.getElementById('run-repo-select').value;
            const taskId = document.getElementById('run-task-select').value;
            const feature1Select = document.getElementById('run-feature1-select');
            const feature2Select = document.getElementById('run-feature2-select');
            
            // Reset feature selects
            feature1Select.innerHTML = '<option value="">Select feature</option>';
            feature2Select.innerHTML = '<option value="">Select feature</option>';
            
            if (!taskId) {
                feature1Select.disabled = true;
                feature2Select.disabled = true;
                updateRunCommand();
                return;
            }
            
            // Find the task and populate features
            const task = allTasks.find(t => t.repo === repo && t.taskId === taskId);
            if (task && task.features.length > 0) {
                task.features.forEach(feature => {
                    const opt1 = document.createElement('option');
                    opt1.value = feature.id;
                    opt1.textContent = `${feature.id}: ${feature.title.substring(0, 50)}${feature.title.length > 50 ? '...' : ''}`;
                    feature1Select.appendChild(opt1);
                    
                    const opt2 = document.createElement('option');
                    opt2.value = feature.id;
                    opt2.textContent = `${feature.id}: ${feature.title.substring(0, 50)}${feature.title.length > 50 ? '...' : ''}`;
                    feature2Select.appendChild(opt2);
                });
                feature1Select.disabled = false;
                feature2Select.disabled = false;
            }
            updateRunCommand();
        }

        function updateRunCommand() {
            const repo = document.getElementById('run-repo-select').value;
            const taskId = document.getElementById('run-task-select').value;
            const feature1 = document.getElementById('run-feature1-select').value;
            const feature2 = document.getElementById('run-feature2-select').value;
            const model1 = document.getElementById('run-model1-select').value;
            const model2 = document.getElementById('run-model2-select').value;
            
            const commandBox = document.getElementById('run-command-box');
            const commandOutput = document.getElementById('run-command-output');
            
            if (!repo || !taskId || !feature1 || !feature2) {
                commandBox.classList.add('hidden');
                return;
            }
            
            // Find task to get repoKey
            const task = allTasks.find(t => t.repo === repo && t.taskId === taskId);
            if (!task) {
                commandBox.classList.add('hidden');
                return;
            }
            
            // Extract numeric IDs from feature IDs (feature1 -> 1, feature2 -> 2)
            const feature1Id = feature1.replace('feature', '');
            const feature2Id = feature2.replace('feature', '');
            
            // Extract numeric task ID (task1621 -> 1621)
            const numericTaskId = taskId.replace('task', '');
            
            const command = `cooperbench run \\
    --setting coop \\
    --repo-name ${task.repoKey} \\
    --task-id ${numericTaskId} \\
    --feature1-id ${feature1Id} \\
    --feature2-id ${feature2Id} \\
    --model1 ${model1} \\
    --model2 ${model2}`;
            
            commandOutput.textContent = command;
            commandBox.classList.remove('hidden');
            
            // Reset copy button text
            document.getElementById('copy-run-text').textContent = 'Copy';
        }

        function copyRunCommand() {
            const commandOutput = document.getElementById('run-command-output').textContent;
            // Copy without the backslashes for easier pasting
            const cleanCommand = commandOutput.replace(/\\\n\s+/g, ' ');
            navigator.clipboard.writeText(cleanCommand).then(() => {
                document.getElementById('copy-run-text').textContent = 'Copied!';
                setTimeout(() => {
                    document.getElementById('copy-run-text').textContent = 'Copy';
                }, 2000);
            });
        }

        // Add event listeners for run command selects
        document.getElementById('run-repo-select').addEventListener('change', onRunRepoChange);
        document.getElementById('run-task-select').addEventListener('change', onRunTaskChange);
        document.getElementById('run-feature1-select').addEventListener('change', updateRunCommand);
        document.getElementById('run-feature2-select').addEventListener('change', updateRunCommand);
        document.getElementById('run-model1-select').addEventListener('change', updateRunCommand);
        document.getElementById('run-model2-select').addEventListener('change', updateRunCommand);

        // Close panel on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePanel();
        });

        // Event listeners
        document.getElementById('search-input').addEventListener('input', renderGrid);
        document.getElementById('lang-filter').addEventListener('change', renderGrid);
        document.getElementById('repo-filter').addEventListener('change', renderGrid);

        // Load
        loadTasks();
    </script>
</body>
</html>
